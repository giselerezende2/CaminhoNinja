<!DOCTYPE html>
<html lang="pt-br">

<head>
    <link rel="shortcut icon" href="../assets/icon/janela.png" type="image/x-icon">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classificação</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="./../css/dashboards.css">
    <link rel="stylesheet" href="./../css/estilo.css" />

    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Exo+2:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
        rel="stylesheet">
</head>

<body onload="inicializarPagina()">

    <div class="janela">
        <div class="header-left dash-header">
            <img src="../assets/imgs/LOGO__2_-removebg-preview.png" style="width: 200px;" alt="">
            <div class="hello">
                <h3>Olá, <span id="b_usuario">usuário</span>!</h3>
            </div>
            <div class="btn-nav">
                <h3>Classificação</h3>
            </div>
            <div class="btn-nav-white">
                <a href="./dashboard.html">
                    <h3>Quiz</h3>
                </a>
            </div>
            <div class="btn-nav-white">
                <a href="./mural.html">
                    <h3>Fórum</h3>
                </a>
            </div>
            <div class="btn-logout" onclick="limparSessao()">
                <h3>Sair</h3>
            </div>
        </div>

        <div class="container-classificacao">
            <h2>Tabela de Classificação</h2>
            <table border="1" id="tabelaClassificacao">
                <thead>
                    <tr>
                        <th>Posição</th>
                        <th>Jogador</th>
                        <th>Acertos</th>
                    </tr>
                </thead>
                <tbody id="corpoTabela">
                    <!-- linhas da tabela que serão adicionadas com os resultados do quiz -->
                </tbody>
            </table>
        </div>
    </div>

    <div class="graficoEvolu">
        <!-- <canvas id="myChart" style="position: relative; height:40vh; width:40vw"></canvas> -->
        <canvas id="myChart" width="200px" height="70" style="padding: 3rem;"></canvas>
    </div>


    <script src="../js/sessao.js"></script>
    <script src="../js/alerta.js"></script>
    <script>
        b_usuario.innerHTML = sessionStorage.NOME_USUARIO;

        function adicionarUsuario(tabela, nomeUsuario, acertos, posicao) {
            var linha = document.createElement('tr');
            var lugar = document.createElement('td');
            var jogador = document.createElement('td');
            var qtdAcerto = document.createElement('td');
            lugar.innerHTML = `${posicao}`;
            jogador.textContent = nomeUsuario;
            qtdAcerto.textContent = acertos;
            linha.appendChild(lugar);
            linha.appendChild(jogador);
            linha.appendChild(qtdAcerto);
            tabela.appendChild(linha);
        }

        function atualizarTabela() {
            fetch('/medidas/classificacao')
                .then(response => response.json())
                .then(data => {
                    var tabela = document.getElementById("corpoTabela");

                    var linhas = tabela.querySelectorAll("tr");
                    for (var i = 0; i < linhas.length; i++) {
                        var linha = linhas[i];
                        var jogador = linha.querySelector("td:nth-child(2)")
                        var pontuacao = parseInt(linha.querySelector("td:nth-child(3)"));
                        console.log(jogador, pontuacao);
                    }

                    for (var i = 0; i < data.length; i++) {
                        var item = data[i];
                        var nomeUsuario = item.nome;
                        var acertos = item.acertos;

                        adicionarUsuario(tabela, nomeUsuario, acertos, i + 1);
                    }
                })
                .catch(error => console.error('Erro ao buscar classificação:', error));
        }

        // plotar grafico 

        function plotarGrafico(dados) {
            // const ctx = document.getElementById('myChart').getContext('2d');

            // const labels = dados.map(item => item.dados);
            // const acertos = dados.map(item => item.acertos);
            // //  

            // const data = {
            //     labels: labels,
            //     datasets: [
            //         {
            //             label: 'Acertos',
            //             data: acertos,
            //             backgroundColor: 'rgba(75, 192, 192, 0.2)',
            //             borderColor: 'rgba(75, 192, 192, 1)',
            //             borderWidth: 1
            //         },
            //         {
            //             label: 'Mais Posts',
            //             data: posts,
            //             backgroundColor: 'rgba(153, 102, 255, 0.2)',
            //             borderColor: 'rgba(153, 102, 255, 1)',
            //             borderWidth: 1
            //         }
            //     ]
            // };

            // const config = {
            //     type: 'bar',
            //     data: data,
            //     options: {
            //         scales: {
            //             y: {
            //                 beginAtZero: true
            //             }
            //         }
            //     }
            // };

            // new Chart(ctx, config);
        }

        function obterDadosGrafico() {
            var fk_usuario = sessionStorage.ID_USUARIO

            fetch(`/medidas/ultimas/${fk_usuario}`, { cache: 'no-store' })
                .then(response => response.json())
                .then(dados => {
                    console.log(dados)
                    const ctx = document.getElementById('myChart').getContext('2d');

                    const labels = dados.map(item => item.dados);
                    const acertos = dados.map(item => item.acertos);
                    console.log(acertos)
                    //  

                    const data = {
                        labels: acertos,
                        datasets: [
                            {
                                label: 'Acertos',
                                data: acertos,
                                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                borderColor: 'rgba(75, 192, 192, 1)',
                                borderWidth: 1
                            }
                        ]
                    };

                    const config = {
                        type: 'bar',
                        data: data,
                        options: {
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    };

                    new Chart(ctx, config);
                })
                .catch(error => console.error('Erro na obtenção dos dados p/ gráfico:', error));
        }

        function inicializarPagina() {
            atualizarTabela();
            obterDadosGrafico();
        }


        //         let proximaAtualizacao;

        //         function obterDadosGrafico() {
        //     if (typeof proximaAtualizacao !== 'undefined') {
        //         clearTimeout(proximaAtualizacao);
        //     }

        //     fetch(`/medidas/ultimas`, { cache: 'no-store' })
        //         .then(function (response) {
        //             if (response.ok) {
        //                 response.json().then(function (resposta) {
        //                     console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
        //                     plotarGrafico(resposta);
        //                 });
        //             } else {
        //                 console.error('Nenhum dado encontrado ou erro na API');
        //             }
        //         })
        //         .catch(function (error) {
        //             console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
        //         });
        // }


    </script>
</body>

</html>